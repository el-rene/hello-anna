---
title: "Markdown_Testdatei"
author: "Anna"
date: "1/8/2020"
output: html_document
---
# Daten Upload und Bereinigung (RL)
```{r liabraries laden, include=TRUE}
# benötigte Libraries laden

library(readxl)
library(tidyverse)
library(lubridate) 
```


```{r import der Daten, include=TRUE}

# Import der Daten

raw_data <- read_excel("Online_Retail_Data.xlsx")
```


```{r Manipulation der Rohdaten, include=TRUE}
# Manipulation der Daten

weekend <- c("Sa", "So") # Sa. und So. als Value, um Weekend-Spalte im nächsten Schritt zu erzeugen

bereinigte_daten <- raw_data %>% # Verwende die hochgeladenen Rohdaten und dann...
  distinct(InvoiceNo, StockCode, Description, Quantity, InvoiceDate, UnitPrice, CustomerID, Country) %>% # lösche doppelte Werte 
  filter(Country == "United Kingdom", # filtere diese auf UK, 
         CustomerID != is.na(CustomerID), # schließe Customer ohne ID aus und
         Quantity > 0, # berücksichtige nur Artikel mit einer Quantity größer Null (nochmal überdenken, aber für den Moment zum arbeiten okay)
         UnitPrice > 0) %>% # und filtere negative Preise raus. 
  mutate(InvoiceNo = factor(InvoiceNo), # Ändere InvoiceNo, StockCode, CustomerID und Country in Faktoren
         StockCode = factor(StockCode),
         CustomerID = factor(CustomerID),
         Country = factor(Country),
         date = floor_date(InvoiceDate, "day"), # erzeuge eine Date Spalte aus dem InvoiceDate
         hour = hour(InvoiceDate), # erzeuge eine zusätzliche hour Spalte,
         weekday = wday(InvoiceDate, label = TRUE), # eine weekdaySpalte
         is_weekend = weekday %in% weekend) # sowie eine Spalte ob eine Order am Wochenende erfolgte. 

```

# Beschreibung der Daten (AH)

```{r Datentransformation Kunden, include=TRUE}
# Kunden
# Tabelle nach Kunden sortiert

customer_summary <- 
  bereinigte_daten %>% 
  group_by(CustomerID) %>% 
  summarise(orders = n(), # Anzahl an Orders n()
            quantity = sum(Quantity),
            revenue = sum(Quantity * UnitPrice),
            UnitPrice = sum(UnitPrice),
            first_order = min(date),
            last_order = max(date)) %>% 
  mutate(avg_order_val = revenue / orders,
         avg_item_val = revenue / quantity)

#Wie viele Kunden haben wir?
dim(customer_summary) # 3921 Kunden
anzahl_kunden=3921

# Wie viele Bestellungen wurden in dem Zeitraum ausgelöst?

sum(customer_summary$orders)
gesamtbestellungen_kunden=349227

# Wie viele Bestellungen pro Kunde?

bestellungen_pro_kunde=mean(customer_summary$orders)
durchschnittliche_bestellungen=gesamtbestellungen_kunden/anzahl_kunden #das gleiche wie drüber

summary(customer_summary$orders)

bestellungen_pro_kunde_median=median(customer_summary$orders)

# Wir sehen das mindestens ein Kunde 7676 Bestellungen getätigt hat, deshalb Durschnittswert erhöht
# Betrachtet man stattdessen den Median, liegt der Durchschnitt bei 40, kommmt der Realität näher, da der Ausreißer nicht so stark ins Gewicht fällt.
bestellungen_pro_kunde_median=median(customer_summary$orders)

# Wie viel Umsatz pro Kunde?

umsatz_pro_kunde_mean=mean(customer_summary$revenue)
umsatz_pro_kunde_median=median(customer_summary$revenue)

# Gesamter Umsatz über alle Kunden?

sum(customer_summary$revenue)
gesamtumsatz_kunden=7285025

```

Im Datensatz sind **`r anzahl_kunden` Kunden** enhalten, die gesamt **`r gesamtbestellungen_kunden` Bestellungen** getätigt haben und dabei einen **Gesamtumsatz von `r gesamtumsatz_kunden`** erzeugt haben. Dabei wurden **durchschnittlich pro Kunde `r bestellungen_pro_kunde` Bestellungen** getätigt, allerdings zeigen die Daten, dass unter den Kunden mindestens einer ist, der 7676 Bestellungen getätigt hat. Damit dieser Ausreißer nicht so stark ins Gewicht fällt, betrachten wir zustäzlich den Median, dieser liegt bei `r bestellungen_pro_kunde_median`. Ausgelöst wurde dabei ein **durchschnittlicher Kundenumsatz von `r umsatz_pro_kunde_mean`**, der Median liegt hier bei `r umsatz_pro_kunde_median`.

```{r Datentransformation Bestellungen und Produkt}
## Produkte und Bestellungen


product_summary <- bereinigte_daten %>%
  group_by(StockCode, Description) %>%
  summarise(anzahl = n(),
            unit_price = mean(UnitPrice),
            revenue = anzahl * unit_price) %>% 
  arrange(desc(revenue)) # arrange (zum sortieren einer Tabelle) mit desc dann absteigende Sortierung

anzahl_verschiedene_produkte=3861

höchster_produktumsatz=
zweithöchster_produktumsatz="	Manual"
dritthöchster_Produktumsatz="DOTCOM POSTAGE"

  

# Wochentag, wie viele Bestellungen gab es je Wochentag
weekday_summary <- bereinigte_daten %>%
  group_by(InvoiceNo, weekday) %>%
  summarise(anzahl_produkte = n()) %>%
  group_by(weekday) %>%
  summarise(anzahl_bestellungen = n())

# Uhrzeit, wie viele Bestellungen nach Tageszeit

hour_summary <- bereinigte_daten %>% 
  group_by(InvoiceNo, hour) %>% 
  summarise(anzahl_produkte = n()) %>% 
  group_by(hour) %>% 
  summarise(anzahl_bestellungen_tageszeit = n())

# Wochentag nach Uhrzeit der Bestellung
weekday_hour_summary <- bereinigte_daten %>%
  group_by(InvoiceNo, weekday, hour)%>%
  summarise(anzahl_produkte = n())%>%
  group_by(hour, weekday) %>%
  summarise(anzahl_bestellungen = n())


# Zeigt den Umsatz pro Bestellung an und wie viele Produkte pro Bestellung
order_summary <- bereinigte_daten %>% 
  mutate(revenue = UnitPrice*Quantity) %>% 
  group_by(InvoiceNo, weekday, hour) %>% 
  summarise(anzahl_verschiedene_produkte = n(),
            revenue_order = sum(revenue),
            anzahl_produkte = sum(Quantity))

```

```{r echo= FALSE, results='asis'}
# library laden

library(knitr)
library(kableExtra)

# Tabelle erstellen

kable(product_summary[1:5, 2:5], caption = "Produkte mit höchstem Umsatz")%>% 
  kable_styling(bootstrap_options = c ("striped", "hover", "responsive", full_width = F, position = "float_right")) %>% 
  column_spec(1, bold = T, background = "grey")

```

